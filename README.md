# 🚀 API Battle & Elo Ranking Server ⚔️

欢迎使用 API 对战与排位服务器！🎉 这是一个通用的、独立的对战逻辑后端。

本系统是一个纯粹的 **对战服务器**，它与一个独立的 **API代理服务器** 协同工作，共同驱动一个完整的模型对战、评分和排位工作流。

## ✨ 核心功能

*   **⚔️ 指令驱动的对战流**: 通过在聊天内容中加入简单指令（如`$sA123`, `$B`, `$wA`），即可控制从开始新对战、指定模型回复到标记比赛结果的全过程。
*   **🏆 自动 ELO 排位系统**: 内置标准 ELO 算法，根据每场对战的结果（A胜、B胜、平局、双方皆负）自动更新参战模型的排位分数。
*   **📈 实时排行榜**: 提供一个 API 端点 (`/v1/leaderboard`)，可随时查看所有模型的 ELO 分数、对战次数和实时排名。
*   **🎭 匿名模型对战**: 在对战中，系统会自动从 `models.json` 中随机抽取两个模型作为“助手A”和“助手B”，让您在不知晓具体模型的情况下进行盲测。
*   **📝 会话管理与锁定**: 每个对战会话由唯一的 RPID (Roleplay ID) 追踪。一旦对战结果被提交，该 RPID 将被锁定，防止重复提交或滥用。
*   **🤖 OpenAI 兼容接口**: 所有交互都通过兼容 OpenAI `v1/chat/completions` 的端点进行，方便与现有工具集成。

## ⚔️ 对战指令详解 (Battle Commands)

### 工作流程

一场典型的对战包含三个阶段：**开始 (Start)** -> **对战 (Battle)** -> **标记结果 (Outcome)**。

1.  **开始 (Start)**:
    *   您使用`$sA[RPID]`或`$sB[RPID]`指令发起一个新的对战。
    *   服务器会为这个`RPID`在数据库中创建一个新条目，并随机分配两个模型给A和B。
    *   如果`RPID`已存在，服务器会拒绝创建并提示错误。
    *   指令中指定的助手（A或B）会生成第一条回复。

2.  **对战 (Battle)**:
    *   您使用`$A`或`$B`指令，指定由哪个助手生成下一条回复。
    *   服务器会使用与当前`RPID`绑定的模型进行生成。

3.  **标记结果 (Outcome)**:
    *   在您认为对战可以结束时，使用`$wA`, `$wB`, `$tie`, 或`$bad`指令来标记比赛结果。
    *   服务器会将结果记录到数据库，**锁定**该`RPID`，并根据结果**自动更新**双方模型的ELO分数。
    *   服务器会返回一个包含双方真实模型ID的确认信息。

### 指令集

通过在用户消息**句首**添加指令来控制流程。服务器会自动解析并移除这些指令，确保发送给模型的只有纯净的用户输入。

**1. Start 指令 (开始新会话)**

*   `$startA[RPID]` 或 `$sA[RPID]`
    *   **作用**: 开始一个新会话，`RPID`为指定ID，并让**助手A**先手。
    *   **示例**: `$sA123 你好，我们来一场对决吧！`
*   `$startB[RPID]` 或 `$sB[RPID]`
    *   **作用**: 开始一个新会话，`RPID`为指定ID，并让**助手B**先手。
    *   **示例**: `$sBduel_alpha 讲个故事`

**2. Battle 指令 (在当前会话中继续)**

*   `$battleA` 或 `$A`
    *   **作用**: 在当前`RPID`的会话中，指定由**助手A**生成下一条回复。
*   `$battleB` 或 `$B`
    *   **作用**: 在当前`RPID`的会话中，指定由**助手B**生成下一条回复。

**3. Outcome 指令 (标记结果并结束会话)**

*   `$winA` 或 `$wA`
    *   **作用**: 标记**助手A**获胜。
*   `$winB` 或 `$wB`
    *   **作用**: 标记**助手B**获胜。
*   `$tie`
    *   **作用**: 标记平局。
*   `$bad`
    *   **作用**: 标记双方表现均不佳。

## 🏛️ 架构：对战服务器 + API代理

本项目的定位是一个专用的 **对战服务器**。

### 工作原理

1.  **对战服务器 (本项目)**:
    *   负责处理所有对战逻辑 (`$sA`, `$wB` 等指令)。
    *   从 `models.json` 随机抽取模型进行对战。
    *   负责管理 ELO 分数和排行榜。
    *   当需要模型生成回复时，它会将抽中的模型ID填入请求体，然后向 API 代理服务器发起一个标准的 HTTP 请求。

2.  **API代理服务器 (独立部署)**:
    *   负责接收来自对战服务器的请求。
    *   根据请求中的模型ID，调用对应的真实模型API。
    *   将真实模型的返回结果流式传输回对战服务器。

这种分离使得两个应用都可以独立维护和扩展。

## 🛠️ 安装与使用

### 1. 准备工作

*   **安装 Python 依赖**: `pip install -r requirements.txt`
*   **准备 API 代理**: 确保您有一个独立运行的、能够根据 `model` 字段调用不同模型的 API 代理服务。

### 2. 配置

编辑 `models.json` 文件：
*   这是**最关键**的配置文件。它是一个简单的JSON数组，定义了可以参与对战的模型ID池。
*   **示例**: `["gpt-4o", "claude-3-opus", "gemini-1.5-pro"]`

编辑 `config.jsonc` 文件：
*   `battle_server_port`: 设置本对战服务器的监听端口 (默认为 `5103`)。
*   `api_key`: (可选) 为本服务器设置一个 API Key 以增加安全性。

### 3. 运行对战服务器

```bash
python api_server.py
```

### 4. 配置你的客户端

将你的客户端或应用的 OpenAI API 地址指向本服务器：

*   **API Base URL**: `http://127.0.0.1:5103/v1` (或其他您在 `config.jsonc` 中设置的端口)
*   **API Key**: 如果在 `config.jsonc` 中配置了，请提供。
*   **Model Name**: **必须**设置为 `leinao_arena` (这是一个固定的标识符，用于激活对战模式)。

### 5. 开始对战！ 💬

现在你可以通过发送带指令的消息来开始你的模型对战和评分了！

## 📖 API 端点

*   `POST /v1/chat/completions`: **核心对战端点**。所有对战指令都通过此端点发送。请求体中的 `model` 字段必须是 `leinao_arena`。
*   `GET /v1/leaderboard`: **排行榜端点**。返回所有模型的 ELO 分数排名。
*   `GET /v1/models`: 返回一个固定的模型列表，其中只包含用于触发对战模式的 `leinao_arena` 模型。

## 📂 文件结构

```
.
├── api_server.py               # 核心对战服务器 (FastAPI) 🐍
├── config.jsonc                # 对战服务器的配置文件 ⚙️
├── models.json                 # 定义了可用于对战的模型池 🎯
├── requirements.txt            # Python 依赖包列表 📦
├── README.md                   # 就是你现在正在看的这个文件 👋
└── modules/
    ├── battle_db.py            # 对战会话数据库管理器 🤺
    ├── battle_mode_handler.py  # 对战模式逻辑处理器 ⚔️
    ├── elo_manager.py          # ELO 分数管理器和排行榜 🏆
    └── update_script.py        # 自动更新逻辑脚本 🔄
```

**享受在模型世界中进行量化评估的乐趣吧！** 💖
